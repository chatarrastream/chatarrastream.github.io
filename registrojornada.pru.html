<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Jornada - Flexible At√≥mica</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Reset y configuraci√≥n base */

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            padding: 20px;
        }

        header {
            margin-bottom: 8px;
        }

        /* Contenedor principal para el dise√±o moderno */

        .contenedor {
            width: 95%;
            max-width: 800px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
            text-align: center;
        }

        .hora-display {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        #fecha-actual {
            display: block;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
        }

        /* --- Estilos del Nuevo Men√∫ de Acciones (CSV/PDF) --- */
        .menu-acciones {
            margin-bottom: 25px;
            padding: 15px;
            border: 1px solid #007bff;
            border-radius: 8px;
            background-color: #e9f7ff;
        }

        .menu-acciones h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #007bff;
            font-size: 1.2em;
        }

        .btn-group-csv {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .btn-group-csv button,
        .btn-group-csv label {
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            font-weight: bold;
            flex: 1 1 120px;
            text-align: center;
            border: none;
        }

        #btn-descargar-csv {
            background-color: #007bff;
            color: white;
        }

        #btn-descargar-csv:hover {
            background-color: #0056b3;
        }

        /* Estilo para el bot√≥n/label de Cargar CSV */
        #label-cargar-csv {
            background-color: #17a2b8;
            color: white;
            border: none;
            display: inline-block;
            line-height: 1.2;
        }

        #label-cargar-csv:hover {
            background-color: #138496;
        }

        #file-input-csv {
            display: none;
            /* Oculta el input de archivo real */
        }

        #btn-reset-todo-menu {
            background-color: #dc3545;
            /* Rojo m√°s llamativo para reset */
            color: white;
            border: none;
            font-size: 1em;
        }

        #btn-reset-todo-menu:hover {
            background-color: #c82333;
        }
        
        /* ESTILO NUEVO PARA EL BOT√ìN PDF */
        #btn-descargar-pdf {
            background-color: #6c757d;
            color: white;
            border: none;
            font-size: 1em;
        }

        #btn-descargar-pdf:hover {
            background-color: #5a6268;
        }
        /* FIN ESTILO NUEVO */

        /* Estilos de Entrada Manual (PRIORIDAD) */

        #entrada-manual-container {
            border: 2px solid #007bff;
            padding: 20px;
            border-radius: 12px;
            margin-top: 10px;
            text-align: left;
            background-color: #e9f7ff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        #entrada-manual-container h3 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            color: #007bff;
            font-size: 1.5em;
        }

        .segmento-group {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .manual-form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .manual-form-group input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            flex: 1 1 100px;
            box-sizing: border-box;
        }

        .manual-form-group label {
            flex: 0 0 auto;
            font-weight: bold;
            color: #333;
        }

        #btn-group-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #btn-guardar-manual {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 20px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            flex-grow: 1;
            font-weight: bold;
        }

        #btn-guardar-manual:hover {
            background-color: #218838;
        }

        #btn-dnt-manual {
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 10px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            flex-grow: 1;
            font-weight: bold;
        }

        #btn-dnt-manual:hover {
            background-color: #e0a800;
        }

        /* Estilos del Historial */

        #historial-container {
            text-align: left;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        #historial-container h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #007bff;
        }

        .filtro-mes {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            /* justify-content: flex-end;  Alineado a la derecha */
        }

        #filtroMes {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 0;
            max-width: 200px;
        }

        /* Estilos de la Tabla */

        #tabla-registros {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85em;
        }

        #tabla-registros th,
        #tabla-registros td {
            border: 1px solid #ddd;
            padding: 10px 3px;
            text-align: center;
        }

        #tabla-registros th {
            background-color: #f8f9fa;
            color: #333;
        }

        #tabla-registros tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .registro-jornada {
            color: #007bff;
            font-weight: bold;
        }

        .registro-dnt {
            color: #ffc107;
            font-weight: bold;
        }

        .btn-borrar-registro {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
        }

        .btn-borrar-registro:hover {
            color: #c82333;
        }

        /* Resumen Mensual */

        #resumen-mensual {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: #e9f7ff;
            text-align: center;
        }

        #resumen-mensual p {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        .total-positivo {
            color: #28a745;
        }

        .total-negativo {
            color: #dc3545;
        }

        #mensaje-manual {
            margin-top: 10px;
            font-weight: bold;
            min-height: 20px;
            text-align: center;
        }
    </style>
</head>

<body>
    <header>
        <h1>Registro de Jornada</h1>
    </header>
    <main class="contenedor">
        <p id="fecha-actual"></p>
        <p class="hora-display" id="hora-actual">00:00:00</p>

        <div class="menu-acciones">
            <h3>Gesti√≥n de Datos</h3>
            <div class="btn-group-csv">
                <button id="btn-reset-todo-menu">üö® Resetear TODO</button>
                <button id="btn-descargar-csv">‚¨áÔ∏è Descargar CSV</button>
                <input type="file" id="file-input-csv" accept=".csv">
                <label for="file-input-csv" id="label-cargar-csv">‚¨ÜÔ∏è Cargar CSV</label>
                <button id="btn-descargar-pdf">üìÑ Descargar PDF (Mes)</button>
            </div>
        </div>
        <div id="entrada-manual-container">
            <h3>Registro Manual de Jornada</h3>
            <div class="manual-form-group">
                <label for="manualFecha">Fecha Jornada:</label>
                <input type="date" id="manualFecha">
            </div>

            <div class="segmento-group">
                <h4>Jornada Continua o Ma√±ana Parcial</h4>
                <div class="manual-form-group">
                    <label for="manualEntrada1">Entrada 1:</label>
                    <input type="time" id="manualEntrada1" value="09:00" required>
                    <label for="manualSalida1">Salida 1:</label>
                    <input type="time" id="manualSalida1" value="17:00" required>
                </div>
            </div>

            <div class="segmento-group">
                <h4>Jornada Parcial Tarde</h4>
                <div class="manual-form-group">
                    <label for="manualEntrada2">Entrada 2:</label>
                    <input type="time" id="manualEntrada2" value="">
                    <label for="manualSalida2">Salida 2:</label>
                    <input type="time" id="manualSalida2" value="">
                </div>
                <small style="display: block; text-align: center; color: #666;">Dejar Segmento 2 vac√≠o para Jornada Continua. Rellenar para Jornada Partida.</small>
            </div>

            <div id="btn-group-actions">
                <button id="btn-dnt-manual">üíæ D√≠a No Trabajado (DNT)</button>
                <button id="btn-guardar-manual"> GUARDAR JORNADA </BUTTON>
            </div>

            <p id="mensaje-manual" style="color: #007bff;"></p>
        </div>

        <section id="historial-container">
            <h2>Historial y Resumen Mensual</h2>
            <div class="filtro-mes">
                <label for="filtroMes">Selecciona Mes:</label>
                <input type="month" id="filtroMes">
            </div>
            <div id="resumen-mensual">
                <p>Total Horas Trabajadas: <span id="total-horas-mes">00:00</span></p>
                <p>Objetivo Mensual: 154:00 horas</p>
                <p>Diferencia: <span id="diferencia-horas">00:00</span></p>
            </div>
            <table id="tabla-registros">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>E1</th>
                        <th>S1</th>
                        <th>E2</th>
                        <th>S2</th>
                        <th>Horas Diarias</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <p id="no-registros" style="color: #888; margin-top: 15px; display: none; text-align: center;"> No hay
                registros para el mes seleccionado. </p>
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a elementos del DOM
            const fechaDisplay = document.getElementById('fecha-actual');
            const horaDisplay = document.getElementById('hora-actual');
            const filtroMesInput = document.getElementById('filtroMes');
            const tbody = document.querySelector('#tabla-registros tbody');
            const noRegistrosMsg = document.getElementById('no-registros');
            const totalHorasMesDisplay = document.getElementById('total-horas-mes');
            const diferenciaHorasDisplay = document.getElementById('diferencia-horas');

            // Referencias de Entrada Manual
            const manualFechaInput = document.getElementById('manualFecha');
            const manualEntrada1Input = document.getElementById('manualEntrada1');
            const manualSalida1Input = document.getElementById('manualSalida1');
            const manualEntrada2Input = document.getElementById('manualEntrada2');
            const manualSalida2Input = document.getElementById('manualSalida2');

            const btnGuardarManual = document.getElementById('btn-guardar-manual');
            const mensajeManualDisplay = document.getElementById('mensaje-manual');
            const btnDNTManual = document.getElementById('btn-dnt-manual');

            // Referencias de CSV y Reset
            const btnDescargarCSV = document.getElementById('btn-descargar-csv');
            const fileInputCSV = document.getElementById('file-input-csv');
            const btnResetTodoMenu = document.getElementById('btn-reset-todo-menu');
            
            // Referencias de PDF (NUEVO)
            const btnDescargarPDF = document.getElementById('btn-descargar-pdf'); 
            const historialContainer = document.getElementById('historial-container');


            const OBJETIVO_HORAS_MENSUAL = 154;
            const LOCAL_STORAGE_KEY = 'jornadasCompletas';

            // --- FUNCIONES DE UTILIDAD ---
            const msToHoraMinutos = (ms) => {
                if (ms === 0) return '00:00';
                const totalSegundos = Math.abs(Math.round(ms / 1000));
                const minutos = Math.floor(totalSegundos / 60) % 60;
                const horas = Math.floor(totalSegundos / 3600);
                const signo = ms < 0 ? '-' : '';
                return `${signo}${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            };

            const getFechaId = (timestamp) => {
                const date = new Date(timestamp);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };

            // Nueva funci√≥n de utilidad para formatear la fecha YYYY-MM-DD a DD/MM/AA
            const formatFechaTabla = (fechaId) => {
                if (!fechaId || fechaId.length !== 10) return '-';
                // fechaId: YYYY-MM-DD
                const partes = fechaId.split('-');
                const anio = partes[0].substring(2); // AA
                const mes = partes[1]; // MM
                const dia = partes[2]; // DD
                return `${dia}/${mes}/${anio}`;
            };


            const formatTimestampToLongDate = (timestamp) => {
                const date = new Date(timestamp);
                const optionsFecha = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                return date.toLocaleDateString('es-ES', optionsFecha);
            };

            const actualizarReloj = () => {
                const ahora = new Date();
                const hora = ahora.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                horaDisplay.textContent = hora;
                if (!fechaDisplay.textContent) {
                    const optionsFecha = {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    };
                    fechaDisplay.textContent = ahora.toLocaleDateString('es-ES', optionsFecha);
                }
                if (!manualFechaInput.value) {
                    manualFechaInput.valueAsDate = ahora;
                }
            };

            // FUNCI√ìN PRINCIPAL PARA GUARDAR JORNADA CONTINUA O PARTIDA
            const guardarRegistroManual = () => {
                const fecha = manualFechaInput.value;
                const hE1 = manualEntrada1Input.value;
                const hS1 = manualSalida1Input.value;
                // Los Segmento 2 ahora est√°n vac√≠os por defecto
                const hE2 = manualEntrada2Input.value;
                const hS2 = manualSalida2Input.value;

                mensajeManualDisplay.textContent = '';

                // VALIDACI√ìN BASE: Segmento 1 es obligatorio
                if (!fecha || !hE1 || !hS1) {
                    mensajeManualDisplay.textContent = '‚ùå Error: Por favor, completa la fecha y las horas de Entrada 1 y Salida 1.';
                    return;
                }

                // Determinar si es Jornada Partida o Continua
                const esJornadaPartida = hE2 && hS2;

                // 1. Calcular Timestamps del Segmento 1
                const fechaId = fecha;
                const tsE1 = new Date(`${fecha}T${hE1}:00`).getTime();
                let tsS1 = new Date(`${fecha}T${hS1}:00`).getTime();

                // Validar Timestamps iniciales
                if (isNaN(tsE1) || isNaN(tsS1)) {
                    mensajeManualDisplay.textContent = '‚ùå Error: Formato de fecha/hora inv√°lido en Segmento 1.';
                    return;
                }

                // 2. L√≥gica de Pausa y Noche (Segmento 1)

                // A. Corregir Salida 1 si pasa la medianoche
                if (tsS1 <= tsE1) {
                    tsS1 += 24 * 60 * 60 * 1000;
                }

                const duracionSeg1 = tsS1 - tsE1;
                if (duracionSeg1 <= 0) {
                    mensajeManualDisplay.textContent = '‚ùå Error: La duraci√≥n del Segmento 1 debe ser positiva.';
                    return;
                }

                let duracionMsTotal = duracionSeg1;
                let tsS2 = tsS1; // Si es continua, la salida final es la salida 1

                // 3. Procesar Segmento 2 (SOLO si es jornada partida)
                if (esJornadaPartida) {
                    const tsE2 = new Date(`${fecha}T${hE2}:00`).getTime();
                    tsS2 = new Date(`${fecha}T${hS2}:00`).getTime(); // Inicializamos Salida 2

                    if (isNaN(tsE2) || isNaN(tsS2)) {
                        mensajeManualDisplay.textContent = '‚ùå Error: Formato de fecha/hora inv√°lido en Segmento 2.';
                        return;
                    }

                    // B. La Entrada 2 debe ser estrictamente despu√©s de la Salida 1 (Pausa)
                    if (tsE2 <= tsS1) {
                        mensajeManualDisplay.textContent = '‚ùå Error: La Entrada 2 debe ser posterior a la Salida 1 (Pausa no v√°lida o nula).';
                        return;
                    }

                    // C. Corregir Salida 2 si pasa la medianoche (Jornada Nocturna)
                    if (tsS2 <= tsE2) {
                        tsS2 += 24 * 60 * 60 * 1000;
                    }

                    const duracionSeg2 = tsS2 - tsE2;
                    if (duracionSeg2 <= 0) {
                        mensajeManualDisplay.textContent = '‚ùå Error: La duraci√≥n del Segmento 2 debe ser positiva.';
                        return;
                    }

                    duracionMsTotal += duracionSeg2;
                }

                // 4. Carga y Sobreescritura (At√≥mica)
                let jornadas = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');

                // Eliminar cualquier registro (Jornada o DNT) con esta misma fechaId
                jornadas = jornadas.filter(j => j.fechaId !== fechaId);

                // 5. Crear el Objeto de Jornada At√≥mica
                const nuevaJornada = {
                    fechaId: fechaId,
                    tipo: esJornadaPartida ? 'Partida' : 'Continua',
                    entradaHora: hE1,
                    salidaHora: esJornadaPartida ? hS2 : hS1, // La hora de salida final
                    entradaTs: tsE1,
                    salidaTs: tsS2,
                    duracionMs: duracionMsTotal,
                    // Guardar los 4 segmentos para referencia en la tabla
                    seg1: {
                        e: hE1,
                        s: hS1
                    },
                    seg2: esJornadaPartida ? {
                        e: hE2,
                        s: hS2
                    } : {
                        e: '-',
                        s: '-'
                    }
                };

                jornadas.push(nuevaJornada);

                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(jornadas));

                    let tipoJornada = esJornadaPartida ? 'partida' : 'continua';
                    let mensaje = `‚úÖ Jornada ${tipoJornada} guardada para el ${fecha}. Total: ${msToHoraMinutos(duracionMsTotal)}.`;
                    if (new Date(tsS2).getDate() !== new Date(tsE1).getDate()) {
                        mensaje = `‚úÖ Jornada ${tipoJornada} guardada (Finaliza el ${getFechaId(tsS2)}). Total: ${msToHoraMinutos(duracionMsTotal)}.`;
                    }
                    mensajeManualDisplay.textContent = mensaje;

                    if (fechaId.substring(0, 7) === filtroMesInput.value) {
                        mostrarRegistros();
                    }
                } catch (error) {
                    mensajeManualDisplay.textContent = '‚ùå Error al guardar el registro. El almacenamiento puede estar lleno.';
                    console.error('Error al guardar en localStorage:', error);
                }
            };

            // D√≠a no trabajado manual (guarda un objeto de tipo DNT)
            const guardarDNTManual = () => {
                const fechaId = manualFechaInput.value;
                mensajeManualDisplay.textContent = '';

                if (!fechaId) {
                    mensajeManualDisplay.textContent = 'Por favor, selecciona la fecha del D√≠a No Trabajado.';
                    return;
                }

                let jornadas = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');

                // Eliminar cualquier registro (Jornada o DNT) con esta misma fechaId
                jornadas = jornadas.filter(j => j.fechaId !== fechaId);

                const nuevoDNT = {
                    fechaId: fechaId,
                    tipo: 'DNT',
                    entradaHora: '-',
                    salidaHora: '-',
                    duracionMs: 0,
                    seg1: {
                        e: '-',
                        s: '-'
                    },
                    seg2: {
                        e: '-',
                        s: '-'
                    }
                };

                jornadas.push(nuevoDNT);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(jornadas));

                mensajeManualDisplay.textContent = `üå¥ D√≠a No Trabajado (DNT) guardado para el ${fechaId}.`;
                if (fechaId.substring(0, 7) === filtroMesInput.value) {
                    mostrarRegistros();
                }
            };

            // --- FUNCI√ìN DE RESETEO ---
            const resetearTodo = () => {
                if (confirm('üö® ¬°ADVERTENCIA! ¬øEst√°s ABSOLUTAMENTE seguro de que quieres BORRAR TODOS los registros de jornada? Esta acci√≥n es irreversible.')) {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    mostrarRegistros();
                    mensajeManualDisplay.textContent = '‚úÖ Todos los registros han sido borrados con √©xito.';
                }
            };

            // --- FUNCIONES CSV ---

            // 1. Descargar el historial como CSV
            const descargarCSV = () => {
                const jornadas = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                if (jornadas.length === 0) {
                    mensajeManualDisplay.textContent = '‚ö†Ô∏è No hay registros para descargar.';
                    return;
                }

                // Definir la cabecera
                const headers = ["FechaId", "Tipo", "Entrada1", "Salida1", "Entrada2", "Salida2", "DuracionMs"];
                let csv = headers.join(";") + "\n"; // Usamos punto y coma como separador

                // Rellenar las filas
                jornadas.forEach(j => {
                    const row = [
                        j.fechaId,
                        j.tipo,
                        j.seg1.e,
                        j.seg1.s,
                        j.seg2.e,
                        j.seg2.s,
                        j.duracionMs
                    ];
                    csv += row.join(";") + "\n";
                });

                // Crear el Blob y el enlace de descarga
                const blob = new Blob([csv], {
                    type: 'text/csv;charset=utf-8;'
                });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);

                link.setAttribute("href", url);
                link.setAttribute("download", `registro_jornada_${new Date().toISOString().substring(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                mensajeManualDisplay.textContent = '‚¨áÔ∏è Archivo CSV descargado con √©xito.';
            };

            // 2. Cargar un historial desde CSV
            const cargarCSV = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                if (!confirm(`üö® ¬°ADVERTENCIA! ¬øEst√°s seguro de que quieres cargar el archivo: ${file.name}? Esto SOBRESCRIBIR√Å todos los registros existentes.`)) {
                    fileInputCSV.value = ''; // Limpiar el input para permitir recargar el mismo archivo
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const nuevasJornadas = procesarCSV(text);

                    if (nuevasJornadas.length > 0) {
                        try {
                            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(nuevasJornadas));
                            mostrarRegistros();
                            mensajeManualDisplay.textContent = `‚¨ÜÔ∏è ${nuevasJornadas.length} registros cargados con √©xito desde el CSV.`;
                        } catch (error) {
                            mensajeManualDisplay.textContent = '‚ùå Error al guardar los datos cargados. El almacenamiento puede estar lleno.';
                            console.error('Error al guardar en localStorage:', error);
                        }
                    } else {
                        mensajeManualDisplay.textContent = '‚ùå Error: No se pudo procesar ning√∫n registro v√°lido en el archivo CSV.';
                    }
                    fileInputCSV.value = ''; // Limpiar el input para recargas futuras
                };
                reader.onerror = () => {
                    mensajeManualDisplay.textContent = '‚ùå Error al leer el archivo.';
                    fileInputCSV.value = '';
                };
                reader.readAsText(file);
            };

            // Funci√≥n interna para parsear el CSV cargado
            const procesarCSV = (csvText) => {
                const lineas = csvText.split('\n').filter(l => l.trim() !== '');
                if (lineas.length < 2) return [];

                const headers = lineas[0].split(';'); // Asumimos ';' como separador
                const datos = lineas.slice(1);
                const registrosValidos = [];

                const indice = {
                    fechaId: headers.indexOf("FechaId"),
                    tipo: headers.indexOf("Tipo"),
                    e1: headers.indexOf("Entrada1"),
                    s1: headers.indexOf("Salida1"),
                    e2: headers.indexOf("Entrada2"),
                    s2: headers.indexOf("Salida2"),
                    duracionMs: headers.indexOf("DuracionMs")
                };

                // Comprobaci√≥n r√°pida de cabeceras
                if (Object.values(indice).some(i => i === -1)) {
                    alert('Error: El formato del archivo CSV no coincide con el esperado (FechaId;Tipo;Entrada1;Salida1;Entrada2;Salida2;DuracionMs).');
                    return [];
                }

                datos.forEach(linea => {
                    const valores = linea.split(';');
                    if (valores.length < 7) return; // L√≠nea incompleta

                    const jornada = {
                        fechaId: valores[indice.fechaId].trim(),
                        tipo: valores[indice.tipo].trim(),
                        duracionMs: parseInt(valores[indice.duracionMs].trim(), 10) || 0,
                        seg1: {
                            e: valores[indice.e1].trim(),
                            s: valores[indice.s1].trim()
                        },
                        seg2: {
                            e: valores[indice.e2].trim(),
                            s: valores[indice.s2].trim()
                        },
                        // Estos campos son necesarios para la estructura interna, aunque no se usen al cargar
                        entradaHora: valores[indice.e1].trim(),
                        salidaHora: valores[indice.s2].trim() !== '-' ? valores[indice.s2].trim() : valores[indice.s1].trim(),
                        entradaTs: null, // Se podr√≠an recalcular, pero para el display no es vital
                        salidaTs: null // Se podr√≠an recalcular, pero para el display no es vital
                    };

                    if (jornada.fechaId && (jornada.tipo === 'DNT' || jornada.duracionMs > 0)) {
                        registrosValidos.push(jornada);
                    }
                });

                return registrosValidos;
            };

            // --- FUNCI√ìN PDF (NUEVO) ---
            const descargarPDF = async () => {
                const mesSeleccionado = filtroMesInput.value;
                if (!mesSeleccionado) {
                    mensajeManualDisplay.textContent = '‚ö†Ô∏è Selecciona un mes para generar el PDF.';
                    return;
                }
                
                // Ocultar elementos que no deben ir en el PDF (p.ej., el bot√≥n de borrar de cada fila)
                document.querySelectorAll('.btn-borrar-registro').forEach(btn => btn.style.display = 'none');
                
                mensajeManualDisplay.textContent = '‚è≥ Generando PDF... Por favor, espera.';

                try {
                    // Usamos window.jspdf ya que se carga desde el CDN
                    const { jsPDF } = window.jspdf; 
                    const doc = new jsPDF('p', 'mm', 'a4'); 
                    
                    // 1. Convertir el contenedor de historial a Canvas (Imagen)
                    const canvas = await html2canvas(historialContainer, {
                        scale: 2, // Mayor escala para mejor calidad
                        useCORS: true,
                        logging: false 
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgProps = doc.getImageProperties(imgData);
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    // Calcular la altura proporcional para que no se corte
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; 

                    // 2. Agregar la imagen al PDF
                    doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                    // 3. Descargar el archivo
                    doc.save(`Registro_Jornada_${mesSeleccionado}.pdf`);
                    mensajeManualDisplay.textContent = '‚úÖ PDF generado y descargado con √©xito.';

                } catch (error) {
                    mensajeManualDisplay.textContent = '‚ùå Error al generar el PDF. Revisa la consola para m√°s detalles.';
                    console.error('Error al generar PDF:', error);
                } finally {
                    // 4. Restaurar elementos ocultos
                    document.querySelectorAll('.btn-borrar-registro').forEach(btn => btn.style.display = '');
                }
            };
            
            // --- FUNCIONES DE HISTORIAL Y C√ÅLCULOS ---

            const procesarRegistros = (filtroValue) => {
                let totalHorasMesMs = 0;
                const jornadas = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                const jornadasDiarias = {};

                // 1. Filtrar solo las jornadas que caen en el mes seleccionado
                const jornadasFiltradas = jornadas
                    .filter(jornada => jornada.fechaId.substring(0, 7) === filtroValue)
                    .sort((a, b) => a.fechaId.localeCompare(b.fechaId)); // Ordenar por fechaId

                // 2. C√≥mputo Final
                jornadasFiltradas.forEach(jornada => {
                    const id = jornada.fechaId;
                    const dateObj = new Date(`${id}T00:00:00`);

                    // Solo intentar obtener d√≠a de la semana si es una fecha v√°lida
                    let diaSemana = '-';
                    if (!isNaN(dateObj.getTime())) {
                        const options = {
                            weekday: 'long'
                        };
                        diaSemana = dateObj.toLocaleDateString('es-ES', options);
                    }

                    jornadasDiarias[id] = {
                        dia: diaSemana,
                        ...jornada
                    };

                    totalHorasMesMs += jornada.duracionMs;
                });

                return {
                    diarios: jornadasDiarias,
                    totalMensualMs: totalHorasMesMs
                };
            };


            const mostrarRegistros = () => {
                // 1. Limpieza y preparaci√≥n
                tbody.innerHTML = '';
                noRegistrosMsg.style.display = 'none';
                diferenciaHorasDisplay.classList.remove('total-positivo', 'total-negativo');

                const filtroValue = filtroMesInput.value;
                if (!filtroValue) return;

                const {
                    diarios,
                    totalMensualMs
                } = procesarRegistros(filtroValue);
                const idsOrdenadas = Object.keys(diarios).sort();

                // 2. Renderizar filas de la tabla
                if (idsOrdenadas.length > 0) {
                    idsOrdenadas.forEach(id => {
                        const dia = diarios[id];
                        const row = tbody.insertRow();

                        // MODIFICACI√ìN APLICADA: Mostrar la fecha completa DD/MM/AA
                        row.insertCell().textContent = formatFechaTabla(dia.fechaId);

                        const tipoCell = row.insertCell();
                        tipoCell.textContent = dia.tipo === 'DNT' ? 'DNT' : dia.tipo; // Muestra Continua/Partida
                        tipoCell.className = dia.tipo === 'DNT' ? 'registro-dnt' : 'registro-jornada';

                        // Mostrar los 4 segmentos de hora
                        row.insertCell().textContent = dia.seg1.e;
                        row.insertCell().textContent = dia.seg1.s;
                        row.insertCell().textContent = dia.seg2.e;
                        row.insertCell().textContent = dia.seg2.s;
                        row.insertCell().textContent = msToHoraMinutos(dia.duracionMs);

                        // Celda de Acci√≥n (Bot√≥n de Borrado)
                        const accionCell = row.insertCell();
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = '‚ùå';
                        deleteButton.className = 'btn-borrar-registro';
                        deleteButton.title = 'Borrar el registro de este d√≠a';

                        deleteButton.addEventListener('click', () => {
                            if (confirm(`¬øEst√°s seguro de que quieres borrar el registro del d√≠a ${dia.dia} (${id})?`)) {

                                let jornadas = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');

                                const jornadasActualizadas = jornadas.filter(j => j.fechaId !== id);

                                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(jornadasActualizadas));
                                mostrarRegistros();
                                mensajeManualDisplay.textContent = `üóëÔ∏è Se ha borrado el registro del d√≠a ${dia.dia}.`;
                            }
                        });
                        accionCell.appendChild(deleteButton);
                    });
                } else {
                    noRegistrosMsg.style.display = 'block';
                }

                // 3. Renderizar Resumen Mensual
                totalHorasMesDisplay.textContent = msToHoraMinutos(totalMensualMs);
                const objetivoMensualMs = OBJETIVO_HORAS_MENSUAL * 3600 * 1000;
                const diferenciaMs = totalMensualMs - objetivoMensualMs;
                diferenciaHorasDisplay.textContent = msToHoraMinutos(diferenciaMs);

                if (diferenciaMs >= 0) {
                    diferenciaHorasDisplay.classList.add('total-positivo');
                    diferenciaHorasDisplay.classList.remove('total-negativo');
                } else {
                    diferenciaHorasDisplay.classList.add('total-negativo');
                    diferenciaHorasDisplay.classList.remove('total-positivo');
                }
            };

            const inicializarFiltro = () => {
                const hoy = new Date();
                const mesActual = String(hoy.getMonth() + 1).padStart(2, '0');
                const anioActual = hoy.getFullYear();
                filtroMesInput.value = `${anioActual}-${mesActual}`;
            };

            // --- INICIALIZACI√ìN Y EVENT LISTENERS ---
            btnGuardarManual.addEventListener('click', guardarRegistroManual);
            btnDNTManual.addEventListener('click', guardarDNTManual);

            // Event Listeners para CSV y Reset (Nuevos)
            btnDescargarCSV.addEventListener('click', descargarCSV);
            fileInputCSV.addEventListener('change', cargarCSV);
            btnResetTodoMenu.addEventListener('click', resetearTodo);
            
            // Event Listener para PDF (NUEVO)
            btnDescargarPDF.addEventListener('click', descargarPDF); 

            actualizarReloj();
            setInterval(actualizarReloj, 1000);

            inicializarFiltro();
            mostrarRegistros();

            filtroMesInput.addEventListener('change', mostrarRegistros);
        });
    </script>
</body>

</html>
