<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Jornada - Completo</title>
    <style>
        /* Reset y configuraci√≥n base */
        
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            padding: 20px;
        }

        header {
            margin-bottom: 20px;
        }

        /* Contenedor principal para el dise√±o moderno */
        
        .contenedor {
            width: 95%;
            max-width: 800px;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            background-color: white;
            text-align: center;
        }

        /* Estilos del Reloj y Fecha */
        
        .hora-display {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #007bff;
        }

        #fecha-actual {
            display: block;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #555;
        }

        /* Grupos de Botones */
        
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .button-group button {
            flex-grow: 1;
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }

        #btn-entrada {
            background-color: #28a745;
            color: white;
        }

        #btn-entrada:hover {
            background-color: #218838;
        }

        #btn-salida {
            background-color: #dc3545;
            color: white;
        }

        #btn-salida:hover {
            background-color: #c82333;
        }

        #btn-dnt {
            background-color: #ffc107;
            color: #333;
            width: 100%;
        }

        #btn-dnt:hover {
            background-color: #e0a800;
        }

        #mensaje {
            margin-top: 20px;
            font-weight: bold;
            min-height: 20px;
        }

        /* Estilos de Entrada Manual */
        
        #entrada-manual-container {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: left;
            background-color: #fcfcfc;
        }

        #entrada-manual-container h3 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            color: #007bff;
        }

        .manual-form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        /* Esto hace que los campos de fecha/hora y el bot√≥n se estiren */
        
        .manual-form-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex: 0 0 auto;
            /* Importante: no se estiran */
        }

        .manual-form-group label {
            flex: 0 0 auto;
            min-width: auto;
            font-weight: bold;
            padding: 0 5px;
        }

        .manual-form-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #btn-guardar-manual {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            /* Se ha eliminado la restricci√≥n de ancho fijo */
        }

        #btn-guardar-manual:hover {
            background-color: #5a6268;
        }

        /* NUEVO ESTILO para el bot√≥n DNT manual */
        
        #btn-dnt-manual {
            background-color: #ffc107;
            /* Color similar al DNT de arriba */
            color: #333;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #btn-dnt-manual:hover {
            background-color: #e0a800;
        }

        /* Estilos del Historial */
        
        #historial-container {
            text-align: left;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        #historial-container h2 {
            text-align: center;
            margin-bottom: 15px;
            color: #007bff;
        }

        .filtro-mes {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: space-between;
        }

        #filtroMes {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
            max-width: 200px;
        }

        #btn-reset-todo {
            background-color: #7d0000;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        #btn-reset-todo:hover {
            background-color: #4f0000;
        }

        /* Estilos de la Tabla */
        
        #tabla-registros {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        #tabla-registros th,
        #tabla-registros td {
            border: 1px solid #ddd;
            padding: 10px 5px;
            text-align: center;
        }

        #tabla-registros th {
            background-color: #f8f9fa;
            color: #333;
        }

        #tabla-registros tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .registro-entrada {
            color: #28a745;
            font-weight: bold;
        }

        .registro-salida {
            color: #dc3545;
            font-weight: bold;
        }

        .registro-dnt {
            color: #ffc107;
            font-weight: bold;
        }

        .btn-borrar-registro {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
        }

        .btn-borrar-registro:hover {
            color: #c82333;
        }

        /* Resumen Mensual */
        
        #resumen-mensual {
            margin-top: 20px;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: #e9f7ff;
            text-align: center;
        }

        #resumen-mensual p {
            margin: 5px 0;
            font-size: 1.1em;
            font-weight: bold;
        }

        .total-positivo {
            color: #28a745;
        }

        .total-negativo {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <header>
        <h1>Registro de Jornada</h1>
    </header>
    <main class="contenedor">
        <p id="fecha-actual"></p>
        <p class="hora-display" id="hora-actual">00:00:00</p>
        <div class="button-group">
            <button id="btn-entrada">Entrada</button>
            <button id="btn-salida">Salida</button>
        </div>
        <button id="btn-dnt">D√≠a No Trabajado (DNT)</button>
        <p id="mensaje"></p>
        <div id="entrada-manual-container">
            <h3>Entrada Manual de Registros</h3>
            <div class="manual-form-group">
                <label for="manualFecha"></label>
                <input type="date" id="manualFecha">
                <label for="manualEntrada">Entrada:</label>
                <input type="time" id="manualEntrada" value="09:00">
                <label for="manualSalida">Salida:</label>
                <input type="time" id="manualSalida" value="18:00">
                <button id="btn-guardar-manual">Guardar</button>
                <button id="btn-dnt-manual">Guardar DNT</button>
            </div>
            <p id="mensaje-manual" style="color: #dc3545;"></p>
        </div>
        <section id="historial-container">
            <h2>Historial y Resumen</h2>
            <div class="filtro-mes">
                <label for="filtroMes">Selecciona Mes:</label>
                <input type="month" id="filtroMes">
                <button id="btn-reset-todo">üî¥ Resetear Todo</button>
            </div>
            <div id="resumen-mensual">
                <p>Total Horas Trabajadas: <span id="total-horas-mes">00:00</span></p>
                <p>Objetivo Mensual: 154:00 horas</p>
                <p>Diferencia: <span id="diferencia-horas">00:00</span></p>
            </div>
            <table id="tabla-registros">
                <thead>
                    <tr>
                        <th>D√≠a</th>
                        <th>Tipo</th>
                        <th>Entrada</th>
                        <th>Salida</th>
                        <th>Horas Diarias</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
            <p id="no-registros" style="color: #888; margin-top: 15px; display: none; text-align: center;"> No hay
                registros para el mes seleccionado. </p>
        </section>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Referencias a elementos del DOM
            const fechaDisplay = document.getElementById('fecha-actual');
            const horaDisplay = document.getElementById('hora-actual');
            const mensajeDisplay = document.getElementById('mensaje');
            const filtroMesInput = document.getElementById('filtroMes');
            const tbody = document.querySelector('#tabla-registros tbody');
            const noRegistrosMsg = document.getElementById('no-registros');
            const totalHorasMesDisplay = document.getElementById('total-horas-mes');
            const diferenciaHorasDisplay = document.getElementById('diferencia-horas');

            // Referencias de Entrada Manual
            const manualFechaInput = document.getElementById('manualFecha');
            const manualEntradaInput = document.getElementById('manualEntrada');
            const manualSalidaInput = document.getElementById('manualSalida');
            const btnGuardarManual = document.getElementById('btn-guardar-manual');
            const mensajeManualDisplay = document.getElementById('mensaje-manual');
            const btnDNTManual = document.getElementById('btn-dnt-manual');

            // Referencia del nuevo bot√≥n de Reseteo
            const btnResetTodo = document.getElementById('btn-reset-todo');

            const OBJETIVO_HORAS_MENSUAL = 154;

            // --- FUNCIONES DE UTILIDAD ---
            const msToHoraMinutos = (ms) => {
                if (ms === 0) return '00:00';
                const totalSegundos = Math.abs(Math.round(ms / 1000));
                const minutos = Math.floor(totalSegundos / 60) % 60;
                const horas = Math.floor(totalSegundos / 3600);
                const signo = ms < 0 ? '-' : '';
                return `${signo}${String(horas).padStart(2, '0')}:${String(minutos).padStart(2, '0')}`;
            };

            const getFechaId = (timestamp) => {
                const date = new Date(timestamp);
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            };

            const formatTimestampToLongDate = (timestamp) => {
                const date = new Date(timestamp);
                const optionsFecha = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                return date.toLocaleDateString('es-ES', optionsFecha);
            };

            // --- FUNCIONES DE REGISTRO ---
            const obtenerFechaHora = (date) => {
                const optionsFecha = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                // A√±adido hour12: false para garantizar formato 24h
                const optionsHora = {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                const fecha = date.toLocaleDateString('es-ES', optionsFecha);
                const hora = date.toLocaleTimeString('es-ES', optionsHora);
                return {
                    fechaCompleta: fecha,
                    horaCompleta: hora
                };
            };

            const actualizarReloj = () => {
                const ahora = new Date();
                // A√±adido hour12: false para garantizar formato 24h
                const hora = ahora.toLocaleTimeString('es-ES', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                horaDisplay.textContent = hora;
                if (!fechaDisplay.textContent) {
                    fechaDisplay.textContent = obtenerFechaHora(ahora).fechaCompleta;
                }
                if (!manualFechaInput.value) {
                    manualFechaInput.valueAsDate = ahora;
                }
            };

            const guardarRegistro = (tipo, timestamp = null) => {
                const ahora = timestamp ? new Date(timestamp) : new Date();
                const {
                    fechaCompleta,
                    horaCompleta
                } = obtenerFechaHora(ahora);
                const fechaId = getFechaId(ahora.getTime());

                let registros = JSON.parse(localStorage.getItem('registrosJornada') || '[]');

                // L√ìGICA: Validar el estado del d√≠a para el turno partido
                if (tipo === 'E' || tipo === 'S') {
                    const registrosDia = registros
                        .filter(r => r.fechaId === fechaId && (r.tipo === 'E' || r.tipo === 'S'))
                        .sort((a, b) => a.timestamp - b.timestamp);

                    const ultimoRegistroTipo = registrosDia.length > 0 ? registrosDia[registrosDia.length - 1].tipo : null;

                    if (tipo === 'E' && ultimoRegistroTipo === 'E') {
                        mensajeDisplay.textContent = '‚ùå Error: Ya tienes una **Entrada** registrada. Debes registrar la **Salida** de la pausa o del d√≠a primero.';
                        return;
                    }

                    if (tipo === 'S' && (ultimoRegistroTipo === 'S' || ultimoRegistroTipo === null)) {
                        mensajeDisplay.textContent = '‚ùå Error: Debes registrar una **Entrada** antes de registrar una **Salida**.';
                        return;
                    }
                }


                const nuevoRegistro = {
                    id: Date.now() + Math.random(),
                    tipo: tipo,
                    timestamp: ahora.getTime(),
                    fecha: fechaCompleta,
                    hora: horaCompleta,
                    fechaId: fechaId
                };


                // L√≥gica para manejar la exclusividad del DNT
                if (tipo === 'DNT') {
                    // Si se registra DNT, elimina cualquier Entrada/Salida de ese d√≠a
                    registros = registros.filter(r => r.fechaId !== fechaId);
                } else if (tipo === 'E' || tipo === 'S') {
                    // Si se registra Entrada/Salida, elimina el posible DNT de ese d√≠a
                    registros = registros.filter(r => !(r.fechaId === fechaId && r.tipo === 'DNT'));
                }

                registros.push(nuevoRegistro);

                try {
                    localStorage.setItem('registrosJornada', JSON.stringify(registros));
                    let mensajeTipo;
                    if (tipo === 'E') mensajeTipo = '‚úÖ Entrada';
                    else if (tipo === 'S') mensajeTipo = 'üõë Salida';
                    else if (tipo === 'DNT') mensajeTipo = 'üå¥ D√≠a No Trabajado';

                    mensajeDisplay.textContent = `${mensajeTipo} registrado con √©xito (${tipo === 'DNT' ? 'D√≠a Completo' : horaCompleta}).`;

                    if (fechaId.substring(0, 7) === filtroMesInput.value) {
                        mostrarRegistros();
                    }
                } catch (error) {
                    mensajeDisplay.textContent = '‚ùå Error al guardar el registro. El almacenamiento puede estar lleno.';
                    console.error('Error al guardar en localStorage:', error);
                }
            };

            const guardarRegistroManual = () => {
                const fecha = manualFechaInput.value;
                const horaEntrada = manualEntradaInput.value;
                const horaSalida = manualSalidaInput.value;
                mensajeManualDisplay.textContent = '';

                if (!fecha || !horaEntrada || !horaSalida) {
                    mensajeManualDisplay.textContent = 'Por favor, completa la fecha, entrada y salida.';
                    return;
                }

                if (!/^\d{2}:\d{2}$/.test(horaEntrada) || !/^\d{2}:\d{2}$/.test(horaSalida)) {
                    mensajeManualDisplay.textContent = 'Error: El formato de hora debe ser HH:MM.';
                    return;
                }

                // 1. Crear el Timestamp de Entrada
                const tsEntrada = new Date(`${fecha}T${horaEntrada}:00`).getTime();

                // 2. Crear el Timestamp de Salida (Inicialmente el mismo d√≠a)
                let tsSalida = new Date(`${fecha}T${horaSalida}:00`).getTime();

                if (isNaN(tsEntrada) || isNaN(tsSalida)) {
                    mensajeManualDisplay.textContent = 'Error: Formato de fecha/hora inv√°lido.';
                    return;
                }

                // CORRECCI√ìN PARA JORNADA NOCTURNA MANUAL: 
                // Si la hora de salida es igual o menor a la hora de entrada,
                // significa que la salida es al d√≠a siguiente.
                if (tsSalida <= tsEntrada) {
                    // A√±adir 24 horas (86,400,000 milisegundos) al timestamp de salida
                    tsSalida += 24 * 60 * 60 * 1000;
                }

                // La entrada manual guarda autom√°ticamente un par (E y S)
                guardarRegistro('E', tsEntrada);
                guardarRegistro('S', tsSalida);

                // Opcional: mostrar un mensaje que indique que la salida fue al d√≠a siguiente
                const fechaSalida = getFechaId(tsSalida);
                if (fechaSalida !== fecha) {
                    mensajeManualDisplay.textContent = `‚úÖ Registros manuales guardados. La Salida fue el d√≠a siguiente (${fechaSalida}).`;
                } else {
                    mensajeManualDisplay.textContent = `‚úÖ Registros manuales guardados para el ${fecha}.`;
                }
            };

            //D√≠a no trabajado
            const guardarDNTManual = () => {
                const fecha = manualFechaInput.value;
                mensajeManualDisplay.textContent = '';

                if (!fecha) {
                    mensajeManualDisplay.textContent = 'Por favor, selecciona la fecha del D√≠a No Trabajado.';
                    return;
                }

                const tsDNT = new Date(`${fecha}T12:00:00`).getTime(); // Usar el mediod√≠a como referencia
                guardarRegistro('DNT', tsDNT);

                mensajeManualDisplay.textContent = `D√≠a No Trabajado (DNT) guardado para el ${fecha}.`;
            };

            // --- FUNCI√ìN DE RESETEO ---
            const resetearTodo = () => {
                if (confirm('üö® ¬°ADVERTENCIA! ¬øEst√°s ABSOLUTAMENTE seguro de que quieres BORRAR TODOS los registros de jornada? Esta acci√≥n es irreversible.')) {
                    localStorage.removeItem('registrosJornada');
                    mostrarRegistros();
                    mensajeDisplay.textContent = '‚úÖ Todos los registros han sido borrados con √©xito.';
                }
            };

            // --- FUNCIONES DE HISTORIAL Y C√ÅLCULOS ---
            const calcularDuracion = (entradaTs, salidaTs) => {
                return salidaTs - entradaTs;
            };

            const procesarRegistros = (registros, filtroValue) => {
                let totalHorasMesMs = 0;
                const registrosDiarios = {};
                const registrosPorFechaId = {}; // Nuevo objeto para acceso r√°pido por fechaId

                // 1. Filtrar y ordenar y agrupar por fechaId para un acceso r√°pido
                const registrosFiltrados = registros
                    .filter(registro => {
                        // Se filtra si el registro es del mes actual o del √∫ltimo d√≠a del mes anterior (por si hay jornadas nocturnas largas)
                        const fechaRegistro = new Date(registro.timestamp);
                        const anioMesRegistro = `${fechaRegistro.getFullYear()}-${String(fechaRegistro.getMonth() + 1).padStart(2, '0')}`;
                        const anioMesFiltro = filtroValue;

                        if (anioMesRegistro === anioMesFiltro) return true;

                        // Tambi√©n incluimos el √∫ltimo d√≠a del mes anterior por si hay una Entrada nocturna sin cerrar
                        const fechaFiltro = new Date(`${anioMesFiltro}-01T00:00:00`);
                        const fechaAnterior = new Date(fechaFiltro.getTime() - 24 * 60 * 60 * 1000); // 1 d√≠a antes

                        if (getFechaId(fechaRegistro.getTime()) === getFechaId(fechaAnterior.getTime())) return true;
                        
                        return false;
                    })
                    .sort((a, b) => a.timestamp - b.timestamp);
                
                // Agrupaci√≥n inicial de todos los registros filtrados (incluye el d√≠a anterior si es relevante)
                registrosFiltrados.forEach(registro => {
                    const id = registro.fechaId;
                    if (!registrosPorFechaId[id]) {
                        registrosPorFechaId[id] = [];
                    }
                    registrosPorFechaId[id].push(registro);
                });

                // 2. L√≥gica para linkear entradas nocturnas (CR√çTICO)
                for (const fechaId in registrosPorFechaId) {
                    const eventosDia = registrosPorFechaId[fechaId].sort((a, b) => a.timestamp - b.timestamp);
                    
                    // Buscar entradas sin cerrar en este d√≠a
                    const ultimaEntrada = eventosDia.filter(e => e.tipo === 'E').reverse().find(e => {
                        // Asegurarse de que no est√© seguida por una Salida
                        const indexE = eventosDia.findIndex(e_match => e_match.id === e.id);
                        const siguienteEvento = eventosDia[indexE + 1];
                        return !siguienteEvento || siguienteEvento.tipo === 'E' || siguienteEvento.tipo === 'DNT';
                    });

                    if (ultimaEntrada) {
                        // Calcular el d√≠a siguiente
                        const fechaSiguiente = new Date(ultimaEntrada.timestamp + 24 * 60 * 60 * 1000);
                        const fechaIdSiguiente = getFechaId(fechaSiguiente.getTime());

                        // Buscar la primera Salida del d√≠a siguiente
                        if (registrosPorFechaId[fechaIdSiguiente]) {
                            const primeraSalidaDiaSiguiente = registrosPorFechaId[fechaIdSiguiente]
                                .filter(e => e.tipo === 'S')
                                .sort((a, b) => a.timestamp - b.timestamp)[0];

                            if (primeraSalidaDiaSiguiente) {
                                // Si encontramos una Salida el d√≠a siguiente, la a√±adimos a los eventos del d√≠a de la Entrada 
                                // para que el c√°lculo de duraci√≥n la incluya.
                                eventosDia.push(primeraSalidaDiaSiguiente);
                                eventosDia.sort((a, b) => a.timestamp - b.timestamp); // Reordenar
                                
                                // Eliminar la Salida del d√≠a siguiente para que no se procese como una Entrada sin cerrar
                                // en el loop principal del d√≠a siguiente (si el d√≠a siguiente est√° en el mes del filtro)
                                registrosPorFechaId[fechaIdSiguiente] = registrosPorFechaId[fechaIdSiguiente].filter(r => r.id !== primeraSalidaDiaSiguiente.id);
                            }
                        }
                    }
                }


                // 3. Reagrupaci√≥n y C√≥mputo Final (Aplicamos el filtro del mes actual)
                for (const id of Object.keys(registrosPorFechaId)) {
                    const eventos = registrosPorFechaId[id];
                    
                    // Solo procesamos y mostramos si la fecha est√° en el mes del filtro
                    if (id.substring(0, 7) !== filtroValue) continue; 
                    
                    // Inicializar el d√≠a
                    if (!registrosDiarios[id]) {
                        registrosDiarios[id] = {
                            dia: formatTimestampToLongDate(eventos[0].timestamp).split(', ')[1],
                            eventos: eventos,
                            duracionMs: 0,
                            tipo: 'Jornada'
                        };
                    }
                    
                    // L√≥gica DNT (si el primer evento es DNT, el d√≠a es DNT)
                    if (eventos.length > 0 && eventos[0].tipo === 'DNT') {
                        registrosDiarios[id].tipo = 'DNT';
                        registrosDiarios[id].eventos = [eventos[0]]; // Solo el registro DNT original
                        continue;
                    }


                    const eventosJornada = eventos.filter(e => e.tipo === 'E' || e.tipo === 'S');
                    let duracionDiaMs = 0;

                    for (let i = 0; i < eventosJornada.length; i++) {
                        const actual = eventosJornada[i];
                        if (actual.tipo === 'E') {
                            const indiceSalida = eventosJornada.slice(i + 1).findIndex(e => e.tipo === 'S');

                            if (indiceSalida !== -1) {
                                const indiceAbsolutoSalida = i + 1 + indiceSalida;
                                const salida = eventosJornada[indiceAbsolutoSalida];

                                duracionDiaMs += calcularDuracion(actual.timestamp, salida.timestamp);
                                i = indiceAbsolutoSalida;
                            }
                        }
                    } 

                    // Eliminar d√≠as sin registros v√°lidos
                    if (eventosJornada.length === 0) {
                        delete registrosDiarios[id];
                        continue;
                    }

                    registrosDiarios[id].duracionMs = duracionDiaMs;
                    totalHorasMesMs += duracionDiaMs;
                }


                return { diarios: registrosDiarios, totalMensualMs: totalHorasMesMs };
            };


            const mostrarRegistros = () => {
                // 1. Limpieza y preparaci√≥n
                tbody.innerHTML = '';
                noRegistrosMsg.style.display = 'none';
                diferenciaHorasDisplay.classList.remove('total-positivo', 'total-negativo');

                const filtroValue = filtroMesInput.value;
                if (!filtroValue) return;

                const registros = JSON.parse(localStorage.getItem('registrosJornada') || '[]');
                const {
                    diarios,
                    totalMensualMs
                } = procesarRegistros(registros, filtroValue);
                const idsOrdenadas = Object.keys(diarios).sort();

                // 2. Renderizar filas de la tabla
                if (idsOrdenadas.length > 0) {
                    idsOrdenadas.forEach(id => {
                        const dia = diarios[id];
                        const row = tbody.insertRow();
                        const idsDia = dia.eventos.map(e => e.id);

                        row.insertCell().textContent = dia.dia;
                        const tipoCell = row.insertCell();
                        tipoCell.textContent = dia.tipo === 'DNT' ? 'DNT' : 'Jornada';
                        tipoCell.className = dia.tipo === 'DNT' ? 'registro-dnt' : 'registro-jornada';

                        if (dia.tipo === 'DNT') {
                            row.insertCell().textContent = '-';
                            row.insertCell().textContent = '-';
                            row.insertCell().textContent = '00:00';
                        } else {
                            const eventos = dia.eventos.filter(e => e.tipo === 'E' || e.tipo === 'S'); // Filtramos de nuevo por si se a√±adi√≥ la Salida nocturna
                            const primeraEntrada = eventos.find(e => e.tipo === 'E');
                            const ultimaSalida = [...eventos].reverse().find(e => e.tipo === 'S');

                            row.insertCell().textContent = primeraEntrada ? primeraEntrada.hora : 'N/A';
                            row.insertCell().textContent = ultimaSalida ? ultimaSalida.hora : 'N/A';
                            row.insertCell().textContent = msToHoraMinutos(dia.duracionMs);
                        }

                        // Celda de Acci√≥n (Bot√≥n de Borrado)
                        const accionCell = row.insertCell();
                        const deleteButton = document.createElement('button');
                        deleteButton.textContent = '‚ùå';
                        deleteButton.className = 'btn-borrar-registro';
                        deleteButton.title = 'Borrar todos los registros de este d√≠a';
                        deleteButton.setAttribute('data-ids', JSON.stringify(idsDia));
                        deleteButton.addEventListener('click', (e) => {
                            if (confirm(`¬øEst√°s seguro de que quieres borrar el registro del d√≠a ${dia.dia}?`)) {
                                const idsParaBorrar = JSON.parse(e.currentTarget.getAttribute('data-ids'));
                                let registros = JSON.parse(localStorage.getItem('registrosJornada') || '[]');
                                const registrosActualizados = registros.filter(r => {
                                    // Conservar el registro de Salida si fue "linkeado" desde el d√≠a anterior
                                    // Nota: Esto es complejo sin m√°s metadatos, simplificamos borrando por ID.
                                    return !idsParaBorrar.includes(r.id);
                                });
                                localStorage.setItem('registrosJornada', JSON.stringify(registrosActualizados));
                                mostrarRegistros();
                                mensajeDisplay.textContent = `üóëÔ∏è Se ha borrado el registro del d√≠a ${dia.dia}.`;
                            }
                        });
                        accionCell.appendChild(deleteButton);
                    });
                } else {
                    noRegistrosMsg.style.display = 'block';
                }

                // 3. Renderizar Resumen Mensual
                totalHorasMesDisplay.textContent = msToHoraMinutos(totalMensualMs);
                const objetivoMensualMs = OBJETIVO_HORAS_MENSUAL * 3600 * 1000;
                const diferenciaMs = totalMensualMs - objetivoMensualMs;
                diferenciaHorasDisplay.textContent = msToHoraMinutos(diferenciaMs);

                if (diferenciaMs >= 0) {
                    diferenciaHorasDisplay.classList.add('total-positivo');
                    diferenciaHorasDisplay.classList.remove('total-negativo');
                } else {
                    diferenciaHorasDisplay.classList.add('total-negativo');
                    diferenciaHorasDisplay.classList.remove('total-positivo');
                }
            };

            const inicializarFiltro = () => {
                const hoy = new Date();
                const mesActual = String(hoy.getMonth() + 1).padStart(2, '0');
                const anioActual = hoy.getFullYear();
                filtroMesInput.value = `${anioActual}-${mesActual}`;
            };

            // --- INICIALIZACI√ìN Y EVENT LISTENERS ---
            document.getElementById('btn-entrada').addEventListener('click', () => guardarRegistro('E'));
            document.getElementById('btn-salida').addEventListener('click', () => guardarRegistro('S'));
            document.getElementById('btn-dnt').addEventListener('click', () => guardarRegistro('DNT'));
            btnGuardarManual.addEventListener('click', guardarRegistroManual);
            btnDNTManual.addEventListener('click', guardarDNTManual);
            btnResetTodo.addEventListener('click', resetearTodo);

            actualizarReloj();
            setInterval(actualizarReloj, 1000);

            inicializarFiltro();
            mostrarRegistros();

            filtroMesInput.addEventListener('change', mostrarRegistros);
        });
    </script>
</body>

</html>
